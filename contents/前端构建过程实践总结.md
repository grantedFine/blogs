把所有东西都写在html文件中应该是最原始的前端了：

```c
index.html
```

### html/css/js分离

分离后的目录结构如下：

```c
index.html
// changes start
scripts
    index.js
styles
    index.css
// changes end
```

其中html文件里类似于：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link href="styles/index.css" rel="stylesheet">
  </head>
  <body>
    <script src="scripts/index.js"></script>
  </body>
</html>
```

### 如果要引入第三方文件

可以通过bower或npm安装到本地，也可以直接使用外部cdn。后者更方便一些，以后者为例，如果引入bootstrap，html文件变成：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <!--changes start-->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" rel="stylesheet">
    <!--changes end-->
    <link href="styles/index.css" rel="stylesheet">
  </head>
  <body>
    <!--changes start-->
    <script src="//cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--changes end-->
    <script src="scripts/index.js"></script>
  </body>
</html>
```

### 如果要给css和js加上版本

除了可以借助后端之外，前端可用的方案有grunt-rev、gulp-rev、webpack的long term caching，webpack的方案目前只能给js文件加上版本，如果css不想被打包进去，还要找其它的方案来处理css。
这里以gulp-rev和相关的工具gulp-rev-replace为例，来给css和js加上版本。

下面是gulpfile.js文件：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");

function revCssAndJs() {
    return gulp.src(["styles/*.css", "scripts/*.js"], { base: "." })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("rev", revCssAndJs);
gulp.task("html", ["rev"], revReplaceHtml);
```

其中`dist`目录是最终的目录，而`build`目录暂时存放一些构建时产生的临时文件。

执行`gulp rev`后的目录结构如下：

```c
index.html
scripts
    index.js
styles
    index.css
// changes start
dist
    scripts
        index-c2c488eeb5.js
    styles
        index-d00adbab4c.css
build
    rev-manifest.json
// changes end
```

其中`rev-manifest.json`中的内容如下：

```json
{
  "scripts/index.js": "scripts/index-c2c488eeb5.js",
  "styles/index.css": "styles/index-d00adbab4c.css"
}
```

执行`gulp html`后的目录结构如下：

```c
index.html
scripts
    index.js
styles
    index.css
dist
    // changes start
    index.html
    // changes end
    scripts
        index-c2c488eeb5.js
    styles
        index-d00adbab4c.css
build
    rev-manifest.json
```

其中`dist/index.html`的内容为：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" rel="stylesheet">
    <!--changes start-->
    <link href="styles/index-d00adbab4c.css" rel="stylesheet">
    <!--changes end-->
  </head>
  <body>
    <script src="//cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--changes start-->
    <script src="scripts/index-c2c488eeb5.js"></script>
    <!--changes end-->
  </body>
</html>
```

这样版本化就完成了，`dist`目录取代根目录，成为新的发布目录。

### 如果js变得复杂，需要模块化

常见的前端js模块化方式有commonjs和AMD，相应的工具是webpack/browserify和require.js/webpack。

采用哪种方式往往会受到采用的前端框架影响。例如对于react和相关的工具链，官方推荐commonjs，vuejs也是官方推荐commonjs，而对于angular2，官方推荐system.js，当然也可以不用推荐的方式。

下面以用webpack打包commonjs模块为例，部分目录结构如下：

```c
scripts
    index.js
    // changes start
    a.js
    b.js
    // changes end
```

webpack和现有的 gulp结合，gulpfile.js文件变成：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
// changes start
let webpack = require("webpack-stream");

function bundleJs() {
    return gulp.src("scripts/index.js")
        .pipe(webpack())
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("styles/index.css")
        .pipe(gulp.dest("build/styles/"));
}
// changes end

function revCssAndJs() {
    // changes start
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
    // changes end
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(gulp.dest("dist"));
}

// changes start
gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("rev", ["js", "css"], revCssAndJs);
// changes end
gulp.task("html", ["rev"], revReplaceHtml);
```

这样打包后的js文件，会被移到`build`目录中，最后`build`中变成：

```c
build
    rev-manifest.json
    // changes start
    scripts
        index.js
    styles
        index.css
    // changes end
```

### 使用lint控制代码格式

以ESlint和css lint为例：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
// changes start
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
// changes end

function bundleJs() {
    return gulp.src("scripts/index.js")
        // changes start
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        // changes end
        .pipe(webpack())
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("styles/index.css")
        // changes start
        .pipe(csslint())
        .pipe(csslint.reporter())
        // changes end
        .pipe(gulp.dest("build/styles/"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev"], revReplaceHtml);
```

### css、js、html的压缩

js可以用webpack的插件来压缩，css可以用`gulp-minify-css`来压缩，html可以用`gulp-minify-html`来压缩：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
// changes start
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
// changes end

function bundleJs() {
    return gulp.src("scripts/index.js")
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        // changes start
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            output: {
                filename: "index.min.js"
            }
        }))
        // changes end
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("styles/index.css")
        .pipe(csslint())
        .pipe(csslint.reporter())
        // changes start
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        // changes end
        .pipe(gulp.dest("build/styles/"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        // changes start
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        // changes end
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev"], revReplaceHtml);
```

### js压缩后支持source map

webpack的压缩插件可以产生source map，source map生成后需要复制到发布目录：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");

function bundleJs() {
    return gulp.src("scripts/index.js")
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            // changes start
            devtool: "source-map",
            // changes end
            output: {
                filename: "index.min.js"
            }
        }))
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("styles/index.css")
        .pipe(csslint())
        .pipe(csslint.reporter())
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        .pipe(gulp.dest("build/styles/"));
}
// changes start
function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}
 // changes end
function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
// changes start
gulp.task("map", ["js"], mapJs);
 // changes end
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], revReplaceHtml);
```

### 如果使用LESS或SCSS，并编译成css

以SCSS为例，可以执行shell命令：`sass styles/index.scss > build/index.css`，scss-lint也可以以命令的形式执行`scss-lint styles/*.scss`：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
// changes start
let shell = require("gulp-shell");

let command = "rm -rf build && sass styles/index.scss > build/index.css && scss-lint styles/*.scss";
gulp.task("build", shell.task(`${command} && gulp html && rm -rf build`));
// changes end

function bundleJs() {
    return gulp.src("scripts/index.js")
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            devtool: "source-map",
            output: {
                filename: "index.min.js"
            }
        }))
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    // changes start
    return gulp.src("build/index.css")
    // changes end
        .pipe(csslint())
        .pipe(csslint.reporter())
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        .pipe(gulp.dest("build/styles/"));
}

function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("map", ["js"], mapJs);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], revReplaceHtml);
```

### 如果使用css后处理器工具

如果支持最新的2个浏览器版本：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
let shell = require("gulp-shell");
// changes start
let autoprefixer = require("autoprefixer");
let postcss = require("gulp-postcss");
// changes end

let command = "rm -rf build && sass styles/index.scss > build/index.css && scss-lint styles/*.scss";
gulp.task("build", shell.task(`${command} && gulp html && rm -rf build`));

function bundleJs() {
    return gulp.src("scripts/index.js")
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            devtool: "source-map",
            output: {
                filename: "index.min.js"
            }
        }))
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("build/index.css")
        .pipe(csslint())
        .pipe(csslint.reporter())
        // changes start
        .pipe(postcss([autoprefixer({ browsers: ["last 2 versions"] })]))
        // changes end
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        .pipe(gulp.dest("build/styles/"));
}

function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("map", ["js"], mapJs);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], revReplaceHtml);
```

### 如果写ES6代码，并编译成ES5

这里以babel为例：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
let shell = require("gulp-shell");
let autoprefixer = require("autoprefixer");
let postcss = require("gulp-postcss");
// changes start
let babel = require("gulp-babel");
// changes end

let command = "rm -rf build && sass styles/index.scss > build/index.css && scss-lint styles/*.scss";
gulp.task("build", shell.task(`${command} && gulp html && rm -rf build`));

function bundleJs() {
    return gulp.src("scripts/index.js")
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        // changes start
        .pipe(babel({
            presets: ["es2015"]
        }))
        // changes end
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            devtool: "source-map",
            output: {
                filename: "index.min.js"
            }
        }))
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("build/index.css")
        .pipe(csslint())
        .pipe(csslint.reporter())
        .pipe(postcss([autoprefixer({ browsers: ["last 2 versions"] })]))
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        .pipe(gulp.dest("build/styles/"));
}

function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("map", ["js"], mapJs);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], revReplaceHtml);
```

### 如果使用typescript或coffeescript，并编译成ES5

这里以typescript为例：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
let shell = require("gulp-shell");
let autoprefixer = require("autoprefixer");
let postcss = require("gulp-postcss");
let babel = require("gulp-babel");

// changes start
let command = "rm -rf build && tsc -p scripts --outDir='../build' && sass styles/index.scss > build/index.css && scss-lint styles/*.scss";
// changes end
gulp.task("build", shell.task(`${command} && gulp html && rm -rf build`));

function bundleJs() {
    // changes start
    return gulp.src("build/index.js")
    // changes end
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        .pipe(babel({
            presets: ["es2015"]
        }))
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            devtool: "source-map",
            output: {
                filename: "index.min.js"
            }
        }))
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("build/index.css")
        .pipe(csslint())
        .pipe(csslint.reporter())
        .pipe(postcss([autoprefixer({ browsers: ["last 2 versions"] })]))
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        .pipe(gulp.dest("build/styles/"));
}

function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("map", ["js"], mapJs);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], revReplaceHtml);
```

### 如果不要打包某些通过npm引入的第三方大文件

以react和react-router为例，它们都要通过npm安装，默认会被打包进去。被排除后就不会被打包进去了，但同时需要全局引入相应的js脚本：

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
let shell = require("gulp-shell");
let autoprefixer = require("autoprefixer");
let postcss = require("gulp-postcss");
let babel = require("gulp-babel");

let command = "rm -rf build && tsc -p scripts --outDir='../build' && sass styles/index.scss > build/index.css && scss-lint styles/*.scss";
gulp.task("build", shell.task(`${command} && gulp html && rm -rf build`));

// changes start
let webpackexternals = {
    "react": "React",
    "react-dom": "ReactDOM",
    "history": "History",
    "react-router": "ReactRouter",
};
// changes end

function bundleJs() {
    return gulp.src("build/index.js")
        .pipe(eslint())
        .pipe(eslint.format())
        .pipe(eslint.failAfterError())
        .pipe(babel({
            presets: ["es2015"]
        }))
        .pipe(webpack({
            plugins: [
                new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
            ],
            devtool: "source-map",
            output: {
                filename: "index.min.js"
            },
            // changes start
            externals: webpackexternals
            // changes end
        }))
        .pipe(gulp.dest("build/scripts/"));
}

function bundleCss() {
    return gulp.src("build/index.css")
        .pipe(csslint())
        .pipe(csslint.reporter())
        .pipe(postcss([autoprefixer({ browsers: ["last 2 versions"] })]))
        .pipe(minifyCSS())
        .pipe(rename("index.min.css"))
        .pipe(gulp.dest("build/styles/"));
}

function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

function revReplaceHtml() {
    let manifest = gulp.src("build/rev-manifest.json");
    return gulp.src("index.html")
        .pipe(revReplace({
            manifest: manifest
        }))
        .pipe(minifyHtml({
            conditionals: true,
            spare: true,
        }))
        .pipe(gulp.dest("dist"));
}

gulp.task("js", bundleJs);
gulp.task("css", bundleCss);
gulp.task("map", ["js"], mapJs);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], revReplaceHtml);
```

### 不同的环境，引入不同文件

主要原因是一些库，比如react或vue，开发时使用开发版本可以获得必要的错误提示，而部署后应该使用生产版本。

可用的方法是，在html前引入一个html模板的构建过程，例如ejs，构建时根据环境，引入不同的库，还可以做到开发环境不压缩css/js/html、生产环境压缩的效果。

```javascript
let gulp = require("gulp");
let rev = require("gulp-rev");
let revReplace = require("gulp-rev-replace");
let webpack = require("webpack-stream");
let eslint = require("gulp-eslint");
let csslint = require("gulp-csslint");
let minifyCSS = require("gulp-minify-css");
let rename = require("gulp-rename");
let minifyHtml = require("gulp-minify-html");
let shell = require("gulp-shell");
let autoprefixer = require("autoprefixer");
let postcss = require("gulp-postcss");
let babel = require("gulp-babel");
// changes start
let ejs = require("gulp-ejs");
// changes end

let command = "rm -rf build && tsc -p scripts --outDir='../build' && sass styles/index.scss > build/index.css && scss-lint styles/*.scss";
// changes start
gulp.task("build-dev", shell.task(`${command} && gulp html-dev && rm -rf build`));
// changes end
gulp.task("build", shell.task(`${command} && gulp html && rm -rf build`));

let webpackexternals = {
    "react": "React",
    "react-dom": "ReactDOM",
    "history": "History",
    "react-router": "ReactRouter",
};

// changes start
function bundleJs(isDevelopment) {
    if (isDevelopment) {
        return gulp.src("build/index.js")
            .pipe(eslint())
            .pipe(eslint.format())
            .pipe(eslint.failAfterError())
            .pipe(babel({
                presets: ["es2015"]
            }))
            .pipe(webpack({
                output: {
                    filename: "index.js"
                },
                externals: webpackexternals
            }))
            .pipe(gulp.dest("build/scripts/"));
    } else {
        return gulp.src("build/index.js")
            .pipe(eslint())
            .pipe(eslint.format())
            .pipe(eslint.failAfterError())
            .pipe(babel({
                presets: ["es2015"]
            }))
            .pipe(webpack({
                plugins: [
                    new webpack.webpack.optimize.UglifyJsPlugin({ minimize: true })
                ],
                devtool: "source-map",
                output: {
                    filename: "index.min.js"
                },
                externals: webpackexternals
            }))
            .pipe(gulp.dest("build/scripts/"));
    }
}

function bundleCss(isDevelopment) {
    if (isDevelopment) {
        return gulp.src("build/index.css")
            .pipe(csslint())
            .pipe(csslint.reporter())
            .pipe(postcss([autoprefixer({ browsers: ["last 2 versions"] })]))
            .pipe(rename("index.css"))
            .pipe(gulp.dest("build/styles/"));
    } else {
        return gulp.src("build/index.css")
            .pipe(csslint())
            .pipe(csslint.reporter())
            .pipe(postcss([autoprefixer({ browsers: ["last 2 versions"] })]))
            .pipe(minifyCSS())
            .pipe(rename("index.min.css"))
            .pipe(gulp.dest("build/styles/"));
    }
}
// changes end

function mapJs() {
    return gulp.src("build/scripts/*.map", { base: "build" })
        .pipe(gulp.dest("dist"));
}

function revCssAndJs() {
    return gulp.src(["build/styles/*.css", "build/scripts/*.js"], { base: "build" })
        .pipe(rev())
        .pipe(gulp.dest("dist"))
        .pipe(rev.manifest())
        .pipe(gulp.dest("build"));
}

// changes start
function revReplaceHtml(isDevelopment) {
    let manifest = gulp.src("build/rev-manifest.json");
    if (isDevelopment) (
        return gulp.src("index.html")
            .pipe(ejs( { dotMin: "" }))
            .pipe(revReplace({
                manifest: manifest
            }))
            .pipe(gulp.dest("dist"));
    ) else {
        return gulp.src("index.html")
            .pipe(ejs( { dotMin: ".min" }))
            .pipe(revReplace({
                manifest: manifest
            }))
            .pipe(minifyHtml({
                conditionals: true,
                spare: true,
            }))
            .pipe(gulp.dest("dist"));
    }
}

gulp.task("js-dev", () => bundleJs(true));
gulp.task("css-dev", () => bundleCss(true));
gulp.task("rev-dev", ["js-dev", "css-dev"], revCssAndJs);
gulp.task("html-dev", ["rev-dev"], () => revReplaceHtml(true));

gulp.task("js", () => bundleJs(false));
gulp.task("css", () => bundleCss(false));
gulp.task("map", ["js"], mapJs);
gulp.task("rev", ["js", "css"], revCssAndJs);
gulp.task("html", ["rev", "map"], () => revReplaceHtml(false));
// changes end
```
而html文件变成：
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <!--changes start-->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap<%- dotMin %>.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap-theme<%- dotMin %>.css" rel="stylesheet">
    <link href="styles/index<%- dotMin %>.css" rel="stylesheet">
    <!--changes end-->
  </head>
  <body>
    <!--changes start-->
    <script src="//cdn.bootcss.com/jquery/2.2.0/jquery<%- dotMin %>.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap<%- dotMin %>.js"></script>
    <script src="scripts/index<%- dotMin %>.js"></script>
    <!--changes end-->
  </body>
</html>
```

### 如果不使用公共CDN，而是需要把公共的js/css库分别合并成公共库

这样做主要目的是为了减少公共库的请求次数。

首先需要通过npm包的形式安装这些库，这里以jquery和bootstrap为例：

```javascript
let concat = require("gulp-concat");

gulp.task("public-css", () => {
    return gulp.src(["node_modules/bootstrap/dist/css/bootstrap.min.css",
        "node_modules/bootstrap/dist/css/bootstrap-theme.min.css"])
        .pipe(concat("public.min.css"))
        .pipe(gulp.dest("dist/styles"));
});

gulp.task("public-js", () => {
    return gulp.src(["node_modules/jquery/dist/jquery.min.js",
        "node_modules/bootstrap/dist/js/bootstrap.min.js"])
        .pipe(concat("public.min.js"))
        .pipe(gulp.dest("dist/scripts"));
});
```

当然这里可以加版本号，也可以区分环境合并不同的库，方法和之前提到的一样。

另外对于bootstrap，还需要复制一下字体文件，到发布目录，并保持css和字体文件的相对位置一致。
