# 把含二进制数据的对象序列化成二进制

### 场景

在分层网络中，发送时，低层协议要在高层协议生成的二进制数据基础上加上一些信息；

接收时，低层协议只会反序列化自己需要的信息，中间的二进制数据会不加修改地传给高层协议。

### 手动处理

对于定长的数据类型，例如 int32，可以直接取出数据；

对于不定长的数据类型，例如 string，可以靠存储定长的字节数，反序列化时，按照读取的字节数，再读取不定长的 string。

这种方式对二进制的掌控度高，不过当结构复杂时，容易出错。

### protobuf 方式

protobuf 支持 bytes 类型，所以可以用于处理这种情况。

这种方式需要写 proto 文件，如果调用方也用 protobuf，就比较方便。

### socket.io 的实现思路

socket.io 对数据中的二进制数据，会抽取出来独立发送，原来的位置上被替换为 placeholder 字段，用于反序列化时再替换回来。

这种方式把数据分为两次来发送，第一次发送的是序列化成的字符串，第二次发送的是二进制数据，这样做主要考虑协议的兼容性，虽然降低了效率。
